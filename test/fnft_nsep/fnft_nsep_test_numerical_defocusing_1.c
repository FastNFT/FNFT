/*
 * This file is part of FNFT.
 *
 * FNFT is free software; you can redistribute it and/or
 * modify it under the terms of the version 2 of the GNU General
 * Public License as published by the Free Software Foundation.
 *
 * FNFT is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 * Contributors:
 * Sander Wahls (TU Delft) 2020.
 * Shrinivas Chimmalgi (TU Delft) 2020.
 */

#define FNFT_ENABLE_SHORT_NAMES
#include "fnft.h"
#include "fnft_nsep.h"
#include "fnft__errwarn.h"
#include "fnft__misc.h"
#ifdef DEBUG
#include <stdio.h>
#endif

// This test signal was constructed numerically using a squared
// eigenfunctions approach (currently undocumented).

INT fnft_nsep_test_numerical_defocusing_1(fnft_nsep_opts_t opts)
{
    INT ret_code = SUCCESS;
    COMPLEX q[257] = {
	  -1.224646799147353e-16 -1.000000000000000e+00*I,
	  4.958575863477270e-03 -9.999139324253257e-01*I,
	  9.914834941989553e-03 -9.996557535867556e-01*I,
	  1.486646121753762e-02 -9.992255351293629e-01*I,
	  1.981114037602063e-02 -9.986233964304612e-01*I,
	  2.474656044995194e-02 -9.978495045476670e-01*I,
	  2.967041280483221e-02 -9.969040741491335e-01*I,
	  3.458039277546707e-02 -9.957873674274661e-01*I,
	  3.947420063845177e-02 -9.944996939846427e-01*I,
	  4.434954225521639e-02 -9.930414107119099e-01*I,
	  4.920413002603496e-02 -9.914129216309234e-01*I,
	  5.403568354060422e-02 -9.896146777387679e-01*I,
	  5.884193050974550e-02 -9.876471768071886e-01*I,
	  6.362060742362244e-02 -9.855109631918546e-01*I,
	  6.836946045806812e-02 -9.832066275917778e-01*I,
	  7.308624613986392e-02 -9.807348068220180e-01*I,
	  7.776873222537127e-02 -9.780961835355012e-01*I,
	  8.241469837165866e-02 -9.752914859585403e-01*I,
	  8.702193698581681e-02 -9.723214875772859e-01*I,
	  9.158825390015898e-02 -9.691870068356850e-01*I,
	  9.611146919122979e-02 -9.658889067887437e-01*I,
	  1.005894178568302e-01 -9.624280947628536e-01*I,
	  1.050199506042815e-01 -9.588055219779280e-01*I,
	  1.094009345266493e-01 -9.550221831703751e-01*I,
	  1.137302538602894e-01 -9.510791161860084e-01*I,
	  1.180058106573643e-01 -9.469774015663159e-01*I,
	  1.222255255130815e-01 -9.427181621138542e-01*I,
	  1.263873382314038e-01 -9.383025624428459e-01*I,
	  1.304892085226992e-01 -9.337318085185536e-01*I,
	  1.345291166594347e-01 -9.290071471736219e-01*I,
	  1.385050641451999e-01 -9.241298656226981e-01*I,
	  1.424150743571285e-01 -9.191012909463189e-01*I,
	  1.462571931874501e-01 -9.139227895818048e-01*I,
	  1.500294896693911e-01 -9.085957667768673e-01*I,
	  1.537300565925600e-01 -9.031216660575448e-01*I,
	  1.573570111091273e-01 -8.975019686540915e-01*I,
	  1.609084953244712e-01 -8.917381929464422e-01*I,
	  1.643826768805143e-01 -8.858318938653276e-01*I,
	  1.677777495231562e-01 -8.797846623154523e-01*I,
	  1.710919336597452e-01 -8.735981245551776e-01*I,
	  1.743234769049040e-01 -8.672739415972616e-01*I,
	  1.774706546092394e-01 -8.608138085708608e-01*I,
	  1.805317703852209e-01 -8.542194540993107e-01*I,
	  1.835051566043879e-01 -8.474926396486255e-01*I,
	  1.863891749049580e-01 -8.406351588813996e-01*I,
	  1.891822166549895e-01 -8.336488369964101e-01*I,
	  1.918827034433607e-01 -8.265355300573126e-01*I,
	  1.944890875066079e-01 -8.192971243283599e-01*I,
	  1.969998522048028e-01 -8.119355355761799e-01*I,
	  1.994135124101378e-01 -8.044527084069633e-01*I,
	  2.017286149690021e-01 -7.968506155393050e-01*I,
	  2.039437390508677e-01 -7.891312571484249e-01*I,
	  2.060574965974869e-01 -7.812966601079098e-01*I,
	  2.080685326312766e-01 -7.733488773465004e-01*I,
	  2.099755256919931e-01 -7.652899870567198e-01*I,
	  2.117771881046596e-01 -7.571220920693466e-01*I,
	  2.134722664032811e-01 -7.488473190275220e-01*I,
	  2.150595415594408e-01 -7.404678177830328e-01*I,
	  2.165378293915732e-01 -7.319857605357913e-01*I,
	  2.179059807566857e-01 -7.234033412542090e-01*I,
	  2.191628819424033e-01 -7.147227747822270e-01*I,
	  2.203074548258458e-01 -7.059462962830585e-01*I,
	  2.213386572441211e-01 -6.970761603195620e-01*I,
	  2.222554831260512e-01 -6.881146403164520e-01*I,
	  2.230569628356069e-01 -6.790640276233356e-01*I,
	  2.237421632828668e-01 -6.699266309882163e-01*I,
	  2.243101882349034e-01 -6.607047756134669e-01*I,
	  2.247601784120928e-01 -6.514008026328025e-01*I,
	  2.250913117614586e-01 -6.420170681714502e-01*I,
	  2.253028035440880e-01 -6.325559428166400e-01*I,
	  2.253939065664847e-01 -6.230198106958302e-01*I,
	  2.253639112641428e-01 -6.134110689280702e-01*I,
	  2.252121458875729e-01 -6.037321267363253e-01*I,
	  2.249379765857367e-01 -5.939854048652287e-01*I,
	  2.245408075451487e-01 -5.841733347445754e-01*I,
	  2.240200810749206e-01 -5.742983578586173e-01*I,
	  2.233752776996113e-01 -5.643629249770045e-01*I,
	  2.226059162452232e-01 -5.543694954625831e-01*I,
	  2.217115538890668e-01 -5.443205365827345e-01*I,
	  2.206917862434566e-01 -5.342185227473465e-01*I,
	  2.195462473684421e-01 -5.240659349068888e-01*I,
	  2.182746098475714e-01 -5.138652597205968e-01*I,
	  2.168765847714481e-01 -5.036189890369854e-01*I,
	  2.153519217983015e-01 -4.933296190050293e-01*I,
	  2.137004091173773e-01 -4.829996496179925e-01*I,
	  2.119218734867424e-01 -4.726315837955585e-01*I,
	  2.100161801850217e-01 -4.622279269585629e-01*I,
	  2.079832330202188e-01 -4.517911861173000e-01*I,
	  2.058229742760921e-01 -4.413238694447224e-01*I,
	  2.035353846888411e-01 -4.308284854028210e-01*I,
	  2.011204833905899e-01 -4.203075422836067e-01*I,
	  1.985783278550126e-01 -4.097635474045963e-01*I,
	  1.959090138361041e-01 -3.991990065888195e-01*I,
	  1.931126752878473e-01 -3.886164234561162e-01*I,
	  1.901894842928413e-01 -3.780182988201822e-01*I,
	  1.871396509640029e-01 -3.674071300926750e-01*I,
	  1.839634233556057e-01 -3.567854105877853e-01*I,
	  1.806610873558202e-01 -3.461556290405389e-01*I,
	  1.772329665732632e-01 -3.355202688279109e-01*I,
	  1.736794222269608e-01 -3.248818075811439e-01*I,
	  1.700008530054067e-01 -3.142427163562309e-01*I,
	  1.661976949552672e-01 -3.036054592964712e-01*I,
	  1.622704213150012e-01 -2.929724928016297e-01*I,
	  1.582195423997163e-01 -2.823462651920064e-01*I,
	  1.540456054147336e-01 -2.717292159220797e-01*I,
	  1.497491943300932e-01 -2.611237752035753e-01*I,
	  1.453309296836356e-01 -2.505323633022096e-01*I,
	  1.407914684347414e-01 -2.399573900854312e-01*I,
	  1.361315037693029e-01 -2.294012544305697e-01*I,
	  1.313517649209807e-01 -2.188663436761269e-01*I,
	  1.264530169897083e-01 -2.083550331531031e-01*I,
	  1.214360607215973e-01 -1.978696855383312e-01*I,
	  1.163017323472176e-01 -1.874126504980059e-01*I,
	  1.110509033192973e-01 -1.769862639671666e-01*I,
	  1.056844801665806e-01 -1.665928478672694e-01*I,
	  1.002034041995534e-01 -1.562347093605598e-01*I,
	  9.460865136584136e-02 -1.459141405861812e-01*I,
	  8.890123194077203e-02 -1.356334179441762e-01*I,
	  8.308219036725088e-02 -1.253948018003183e-01*I,
	  7.715260494919460e-02 -1.152005358427565e-01*I,
	  7.111358765732524e-02 -1.050528467175690e-01*I,
	  6.496628384441540e-02 -9.495394348909041e-02*I,
	  5.871187199946019e-02 -8.490601718246339e-02*I,
	  5.235156349987925e-02 -7.491124036145101e-02*I,
	  4.588660230313504e-02 -6.497176657426468e-02*I,
	  3.931826474121625e-02 -5.508973004006528e-02*I,
	  3.264785915182443e-02 -4.526724501934470e-02*I,
	  2.587672570445058e-02 -3.550640557402483e-02*I,
	  1.900623599028010e-02 -2.580928490836280e-02*I,
	  1.203779285383297e-02 -1.617793514878609e-02*I,
	  4.972829970437881e-03 -6.614386708933257e-03*I,
	  -2.187188345104417e-03 +2.879351959247791e-03*I,
	  -9.440767546142181e-03 +1.230129493521291e-02*I,
	  -1.678638309543347e-02 +2.164947914293568e-02*I,
	  -2.422248083266999e-02 +3.092196482709236e-02*I,
	  -3.174747728821614e-02 +4.011683595130733e-02*I,
	  -3.935975999291477e-02 +4.923220056926039e-02*I,
	  -4.705768787600717e-02 +5.826619131010002e-02*I,
	  -5.483959151405124e-02 +6.721696565366822e-02*I,
	  -6.270377360662696e-02 +7.608270648260579e-02*I,
	  -7.064850918239270e-02 +8.486162229403554e-02*I,
	  -7.867204612432105e-02 +9.355194777658311e-02*I,
	  -8.677260536983028e-02 +1.021519440064136e-01*I,
	  -9.494838144624759e-02 +1.106598990019097e-01*I,
	  -1.031975427031239e-01 +1.190741279457855e-01*I,
	  -1.115182318229358e-01 +1.273929736824657e-01*I,
	  -1.199085661190967e-01 +1.356148069954494e-01*I,
	  -1.283666379919235e-01 +1.437380270244440e-01*I,
	  -1.368905153183972e-01 +1.517610616139700e-01*I,
	  -1.454782418342070e-01 +1.596823676419045e-01*I,
	  -1.541278376270326e-01 +1.675004314392601e-01*I,
	  -1.628372994434161e-01 +1.752137690389201e-01*I,
	  -1.716046012756455e-01 +1.828209266483645e-01*I,
	  -1.804276946168728e-01 +1.903204808455481e-01*I,
	  -1.893045091065738e-01 +1.977110390699693e-01*I,
	  -1.982329527786454e-01 +2.049912398041164e-01*I,
	  -2.072109127186186e-01 +2.121597530450461e-01*I,
	  -2.162362553491983e-01 +2.192152805035461e-01*I,
	  -2.253068270591677e-01 +2.261565560293810e-01*I,
	  -2.344204545639413e-01 +2.329823458495184e-01*I,
	  -2.435749454728731e-01 +2.396914489300470e-01*I,
	  -2.527680887533997e-01 +2.462826972644430e-01*I,
	  -2.619976552154649e-01 +2.527549561661814e-01*I,
	  -2.712613980925783e-01 +2.591071246062991e-01*I,
	  -2.805570534404988e-01 +2.653381354427201e-01*I,
	  -2.898823408268253e-01 +2.714469557941278e-01*I,
	  -2.992349636654844e-01 +2.774325872238780e-01*I,
	  -3.086126099804965e-01 +2.832940661262957e-01*I,
	  -3.180129527216953e-01 +2.890304638911891e-01*I,
	  -3.274336505535127e-01 +2.946408872760004e-01*I,
	  -3.368723481986577e-01 +3.001244785726191e-01*I,
	  -3.463266772095320e-01 +3.054804159468777e-01*I,
	  -3.557942563786948e-01 +3.107079136211645e-01*I,
	  -3.652726924579205e-01 +3.158062221700247e-01*I,
	  -3.747595806659254e-01 +3.207746287250740e-01*I,
	  -3.842525053300181e-01 +3.256124572222748e-01*I,
	  -3.937490405093335e-01 +3.303190686288016e-01*I,
	  -4.032467505483554e-01 +3.348938611441704e-01*I,
	  -4.127431908173987e-01 +3.393362704423842e-01*I,
	  -4.222359081854962e-01 +3.436457698347852e-01*I,
	  -4.317224418599180e-01 +3.478218705157867e-01*I,
	  -4.412003238065008e-01 +3.518641216992481e-01*I,
	  -4.506670796504737e-01 +3.557721108536359e-01*I,
	  -4.601202290871787e-01 +3.595454638239943e-01*I,
	  -4.695572868007050e-01 +3.631838450447733e-01*I,
	  -4.789757629026381e-01 +3.666869576545003e-01*I,
	  -4.883731638351351e-01 +3.700545436802026e-01*I,
	  -4.977469928667067e-01 +3.732863841471072e-01*I,
	  -5.070947509528099e-01 +3.763822992323093e-01*I,
	  -5.164139373109877e-01 +3.793421483685390e-01*I,
	  -5.257020502194255e-01 +3.821658303676925e-01*I,
	  -5.349565876853408e-01 +3.848532835150664e-01*I,
	  -5.441750481709752e-01 +3.874044856655819e-01*I,
	  -5.533549313593925e-01 +3.898194543231523e-01*I,
	  -5.624937388072559e-01 +3.920982467136273e-01*I,
	  -5.715889748020477e-01 +3.942409598433417e-01*I,
	  -5.806381469508388e-01 +3.962477305528480e-01*I,
	  -5.896387671132358e-01 +3.981187355492609e-01*I,
	  -5.985883519443642e-01 +3.998541914437304e-01*I,
	  -6.074844238793773e-01 +4.014543547538824e-01*I,
	  -6.163245116556076e-01 +4.029195219259062e-01*I,
	  -6.251061513213214e-01 +4.042500293057121e-01*I,
	  -6.338268867597686e-01 +4.054462531443260e-01*I,
	  -6.424842707007997e-01 +4.065086095382569e-01*I,
	  -6.510758652620887e-01 +4.074375544155918e-01*I,
	  -6.595992429487799e-01 +4.082335834470400e-01*I,
	  -6.680519872222701e-01 +4.088972320094406e-01*I,
	  -6.764316934765213e-01 +4.094290750695513e-01*I,
	  -6.847359696414156e-01 +4.098297271213368e-01*I,
	  -6.929624371276257e-01 +4.100998420448413e-01*I,
	  -7.011087314682044e-01 +4.102401130136213e-01*I,
	  -7.091725032269968e-01 +4.102512723310017e-01*I,
	  -7.171514186790657e-01 +4.101340913043037e-01*I,
	  -7.250431606803416e-01 +4.098893800605009e-01*I,
	  -7.328454293849059e-01 +4.095179873844036e-01*I,
	  -7.405559430757495e-01 +4.090208005152742e-01*I,
	  -7.481724389149302e-01 +4.083987449467781e-01*I,
	  -7.556926737369153e-01 +4.076527842055782e-01*I,
	  -7.631144248262174e-01 +4.067839196115691e-01*I,
	  -7.704354906758240e-01 +4.057931900389165e-01*I,
	  -7.776536917860596e-01 +4.046816716357893e-01*I,
	  -7.847668713911359e-01 +4.034504775678053e-01*I,
	  -7.917728962726021e-01 +4.021007576971094e-01*I,
	  -7.986696574571721e-01 +4.006336983077700e-01*I,
	  -8.054550710381064e-01 +3.990505217445990e-01*I,
	  -8.121270788472891e-01 +3.973524861197290e-01*I,
	  -8.186836492781432e-01 +3.955408849120154e-01*I,
	  -8.251227779345500e-01 +3.936170466538178e-01*I,
	  -8.314424884493098e-01 +3.915823344921794e-01*I,
	  -8.376408331120143e-01 +3.894381458547160e-01*I,
	  -8.437158936775649e-01 +3.871859119740471e-01*I,
	  -8.496657819746023e-01 +3.848270975316465e-01*I,
	  -8.554886406990964e-01 +3.823632001472284e-01*I,
	  -8.611826440044572e-01 +3.797957499994039e-01*I,
	  -8.667459982756994e-01 +3.771263092819274e-01*I,
	  -8.721769427019294e-01 +3.743564718000137e-01*I,
	  -8.774737500270257e-01 +3.714878623955441e-01*I,
	  -8.826347271048399e-01 +3.685221365179090e-01*I,
	  -8.876582156227211e-01 +3.654609796204762e-01*I,
	  -8.925425926394759e-01 +3.623061067048210e-01*I,
	  -8.972862712784181e-01 +3.590592616909702e-01*I,
	  -9.018877012478835e-01 +3.557222169338750e-01*I,
	  -9.063453695008137e-01 +3.522967725701587e-01*I,
	  -9.106578007374094e-01 +3.487847560056733e-01*I,
	  -9.148235580285835e-01 +3.451880212416886e-01*I,
	  -9.188412433001319e-01 +3.415084483323734e-01*I,
	  -9.227094979177277e-01 +3.377479426935447e-01*I,
	  -9.264270031517864e-01 +3.339084345289440e-01*I,
	  -9.299924807220337e-01 +3.299918781248035e-01*I,
	  -9.334046932420297e-01 +3.260002512438618e-01*I,
	  -9.366624447217278e-01 +3.219355544090791e-01*I,
	  -9.397645809903985e-01 +3.177998102644798e-01*I,
	  -9.427099901560104e-01 +3.135950628513386e-01*I,
	  -9.454976030050665e-01 +3.093233769351521e-01*I,
	  -9.481263934180575e-01 +3.049868372775271e-01*I,
	  -9.505953787424140e-01 +3.005875479332825e-01*I,
	  -9.529036201717039e-01 +2.961276315043306e-01*I,
    };
    const REAL T[2] = {0, 0.634747138981829};

    const COMPLEX mainspec_exact[4] = {-4,-3 ,1,2};
    const COMPLEX auxspec_exact[1] = {
        -1
    };
    const UINT K_exact = sizeof(mainspec_exact) / sizeof(mainspec_exact[0]);
    const UINT M_exact = sizeof(auxspec_exact) / sizeof(auxspec_exact[0]);

    COMPLEX *mainspec = NULL;
    COMPLEX *auxspec = NULL;

    const UINT D = sizeof(q) / sizeof(q[0]);
    UINT K = D;
    UINT M = D;
    mainspec = malloc(K * sizeof(COMPLEX));
    auxspec = malloc(M * sizeof(COMPLEX));
    if (mainspec == NULL || auxspec == NULL) {
        ret_code = E_NOMEM;
        goto leave_fun;
    }

    // Compute main and auxiliary spectrum
    REAL phase_shift = CARG(q[D-1]/q[0]);
    ret_code = fnft_nsep(D-1, q, T, phase_shift, &K, mainspec, &M, auxspec, NULL, -1, &opts);
    CHECK_RETCODE(ret_code, leave_fun);

    // Check that the main and auxiliary spectrum are correct
    REAL dist = misc_hausdorff_dist(K_exact, mainspec_exact, K, mainspec);
    if (dist > 8.7e-3) {
        ret_code = E_TEST_FAILED;
        goto leave_fun;
    }
    dist = misc_hausdorff_dist(M_exact, auxspec_exact, M, auxspec);
    if (dist > 0.1) {
        ret_code = E_TEST_FAILED;
        goto leave_fun;
    }


leave_fun:
    free(mainspec);
    free(auxspec);
    return SUCCESS;
}

int main()
{
    fnft_nsep_opts_t opts = fnft_nsep_default_opts();
    opts.filtering = fnft_nsep_filt_MANUAL;
    opts.bounding_box[0] = -5;
    opts.bounding_box[1] = 5;
    opts.bounding_box[2] = -10;
    opts.bounding_box[3] = 10;

    opts.localization = fnft_nsep_loc_SUBSAMPLE_AND_REFINE;
    if (fnft_nsep_test_numerical_defocusing_1(opts) != SUCCESS)
        return EXIT_FAILURE;
 
    opts.localization = fnft_nsep_loc_MIXED;
    if (fnft_nsep_test_numerical_defocusing_1(opts) != SUCCESS)
        return EXIT_FAILURE;
   
    return EXIT_SUCCESS;
}
