/*
 * This file is part of FNFT.
 *
 * FNFT is free software; you can redistribute it and/or
 * modify it under the terms of the version 2 of the GNU General
 * Public License as published by the Free Software Foundation.
 *
 * FNFT is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 * Contributors:
 * Sander Wahls (TU Delft) 2020.
 * Shrinivas Chimmalgi (TU Delft) 2020.
 */

#define FNFT_ENABLE_SHORT_NAMES
#include "fnft.h"
#include "fnft_nsep.h"
#include "fnft__errwarn.h"
#include "fnft__misc.h"
#ifdef DEBUG
#include <stdio.h>
#endif

// This test signal was constructed numerically using a squared
// eigenfunctions approach (currently undocumented).

INT fnft_nsep_test_numerical_focusing_3()
{
    INT ret_code = SUCCESS;
    COMPLEX q[257] = {
	  4.156944615934254e+00 +0.000000000000000e+00*I,
	  4.144213354006609e+00 -4.523857270826502e-02*I,
	  4.131469079810982e+00 -9.042539763695710e-02*I,
	  4.118715107307464e+00 -1.355624426136082e-01*I,
	  4.105954561167653e+00 -1.806517613711287e-01*I,
	  4.093190377510740e+00 -2.256954875058648e-01*I,
	  4.080425304712877e+00 -2.706958284407134e-01*I,
	  4.067661904286240e+00 -3.156550593945404e-01*I,
	  4.054902551821976e+00 -3.605755173597289e-01*I,
	  4.042149437994137e+00 -4.054595950884572e-01*I,
	  4.029404569620004e+00 -4.503097350886603e-01*I,
	  4.016669770771720e+00 -4.951284236317776e-01*I,
	  4.003946683939928e+00 -5.399181847693088e-01*I,
	  3.991236771241568e+00 -5.846815743624124e-01*I,
	  3.978541315668440e+00 -6.294211741242891e-01*I,
	  3.965861422382293e+00 -6.741395856702448e-01*I,
	  3.953198020042104e+00 -7.188394245831820e-01*I,
	  3.940551862166229e+00 -7.635233144901015e-01*I,
	  3.927923528535547e+00 -8.081938811464421e-01*I,
	  3.915313426617820e+00 -8.528537465362447e-01*I,
	  3.902721793030650e+00 -8.975055229783931e-01*I,
	  3.890148695029000e+00 -9.421518072455791e-01*I,
	  3.877594032021379e+00 -9.867951746913456e-01*I,
	  3.865057537113022e+00 -1.031438173386976e+00*I,
	  3.852538778674921e+00 -1.076083318266485e+00*I,
	  3.840037161938832e+00 -1.120733085279794e+00*I,
	  3.827551930617205e+00 -1.165389905553412e+00*I,
	  3.815082168549634e+00 -1.210056159558427e+00*I,
	  3.802626801374290e+00 -1.254734171285222e+00*I,
	  3.790184598224584e+00 -1.299426202424430e+00*I,
	  3.777754173455144e+00 -1.344134446554908e+00*I,
	  3.765333988392887e+00 -1.388861023337362e+00*I,
	  3.752922353115683e+00 -1.433607972714015e+00*I,
	  3.740517428264894e+00 -1.478377249115648e+00*I,
	  3.728117226885059e+00 -1.523170715674434e+00*I,
	  3.715719616294964e+00 -1.567990138443436e+00*I,
	  3.703322319998980e+00 -1.612837180625716e+00*I,
	  3.690922919628743e+00 -1.657713396810321e+00*I,
	  3.678518856921561e+00 -1.702620227217215e+00*I,
	  3.666107435747373e+00 -1.747558991955911e+00*I,
	  3.653685824170363e+00 -1.792530885293692e+00*I,
	  3.641251056553994e+00 -1.837536969936792e+00*I,
	  3.628800035724374e+00 -1.882578171332034e+00*I,
	  3.616329535173584e+00 -1.927655271982395e+00*I,
	  3.603836201314223e+00 -1.972768905781647e+00*I,
	  3.591316555803564e+00 -2.017919552379555e+00*I,
	  3.578766997913648e+00 -2.063107531567005e+00*I,
	  3.566183806961588e+00 -2.108332997688867e+00*I,
	  3.553563144821512e+00 -2.153595934101282e+00*I,
	  3.540901058487612e+00 -2.198896147655653e+00*I,
	  3.528193482715654e+00 -2.244233263227473e+00*I,
	  3.515436242741609e+00 -2.289606718296442e+00*I,
	  3.502625057075678e+00 -2.335015757573904e+00*I,
	  3.489755540378032e+00 -2.380459427686739e+00*I,
	  3.476823206423334e+00 -2.425936571931433e+00*I,
	  3.463823471150480e+00 -2.471445825090939e+00*I,
	  3.450751655806423e+00 -2.516985608330404e+00*I,
	  3.437602990185349e+00 -2.562554124177831e+00*I,
	  3.424372615967060e+00 -2.608149351594063e+00*I,
	  3.411055590157912e+00 -2.653769041141655e+00*I,
	  3.397646888637336e+00 -2.699410710263018e+00*I,
	  3.384141409813354e+00 -2.745071638672551e+00*I,
	  3.370533978390397e+00 -2.790748863875071e+00*I,
	  3.356819349251370e+00 -2.836439176818766e+00*I,
	  3.342992211458363e+00 -2.882139117693099e+00*I,
	  3.329047192373622e+00 -2.927844971881914e+00*I,
	  3.314978861903656e+00 -2.973552766082411e+00*I,
	  3.300781736868459e+00 -3.019258264601189e+00*I,
	  3.286450285498645e+00 -3.064956965839044e+00*I,
	  3.271978932061132e+00 -3.110644098975856e+00*I,
	  3.257362061616732e+00 -3.156314620868535e+00*I,
	  3.242594024909828e+00 -3.201963213174288e+00*I,
	  3.227669143391261e+00 -3.247584279711291e+00*I,
	  3.212581714375543e+00 -3.293171944071065e+00*I,
	  3.197326016332535e+00 -3.338720047494961e+00*I,
	  3.181896314313857e+00 -3.384222147028997e+00*I,
	  3.166286865513372e+00 -3.429671513969903e+00*I,
	  3.150491924961476e+00 -3.475061132617354e+00*I,
	  3.134505751351861e+00 -3.520383699346022e+00*I,
	  3.118322612998679e+00 -3.565631622010669e+00*I,
	  3.101936793922812e+00 -3.610797019699978e+00*I,
	  3.085342600063642e+00 -3.655871722851826e+00*I,
	  3.068534365614855e+00 -3.700847273745192e+00*I,
	  3.051506459478919e+00 -3.745714927381645e+00*I,
	  3.034253291837675e+00 -3.790465652771370e+00*I,
	  3.016769320832779e+00 -3.835090134635590e+00*I,
	  2.999049059352241e+00 -3.879578775540689e+00*I,
	  2.981087081915694e+00 -3.923921698475300e+00*I,
	  2.962878031653822e+00 -3.968108749884140e+00*I,
	  2.944416627372810e+00 -4.012129503169582e+00*I,
	  2.925697670697753e+00 -4.055973262673524e+00*I,
	  2.906716053285485e+00 -4.099629068149237e+00*I,
	  2.887466764098919e+00 -4.143085699734876e+00*I,
	  2.867944896732113e+00 -4.186331683436866e+00*I,
	  2.848145656777552e+00 -4.229355297132857e+00*I,
	  2.828064369222692e+00 -4.272144577100930e+00*I,
	  2.807696485865812e+00 -4.314687325082549e+00*I,
	  2.787037592738267e+00 -4.356971115884677e+00*I,
	  2.766083417520983e+00 -4.398983305525918e+00*I,
	  2.744829836941093e+00 -4.440711039929610e+00*I,
	  2.723272884136168e+00 -4.482141264166784e+00*I,
	  2.701408755969762e+00 -4.523260732248544e+00*I,
	  2.679233820284528e+00 -4.564056017467631e+00*I,
	  2.656744623077213e+00 -4.604513523288039e+00*I,
	  2.633937895579507e+00 -4.644619494777524e+00*I,
	  2.610810561228294e+00 -4.684360030578576e+00*I,
	  2.587359742509010e+00 -4.723721095411083e+00*I,
	  2.563582767654078e+00 -4.762688533097132e+00*I,
	  2.539477177179461e+00 -4.801248080097178e+00*I,
	  2.515040730242166e+00 -4.839385379548165e+00*I,
	  2.490271410800136e+00 -4.877085995785788e+00*I,
	  2.465167433557284e+00 -4.914335429337667e+00*I,
	  2.439727249674810e+00 -4.951119132368790e+00*I,
	  2.413949552231299e+00 -4.987422524559418e+00*I,
	  2.387833281412979e+00 -5.023231009392635e+00*I,
	  2.361377629417210e+00 -5.058529990832429e+00*I,
	  2.334582045050630e+00 -5.093304890361296e+00*I,
	  2.307446238005834e+00 -5.127541164354692e+00*I,
	  2.279970182797368e+00 -5.161224321760878e+00*I,
	  2.252154122342811e+00 -5.194339942056971e+00*I,
	  2.223998571171022e+00 -5.226873693446259e+00*I,
	  2.195504318243177e+00 -5.258811351267768e+00*I,
	  2.166672429370955e+00 -5.290138816575946e+00*I,
	  2.137504249219419e+00 -5.320842134858946e+00*I,
	  2.108001402877657e+00 -5.350907514852343e+00*I,
	  2.078165796989356e+00 -5.380321347412614e+00*I,
	  2.047999620428698e+00 -5.409070224406800e+00*I,
	  2.017505344512190e+00 -5.437140957576125e+00*I,
	  1.986685722737656e+00 -5.464520597333549e+00*I,
	  1.955543790041073e+00 -5.491196451446696e+00*I,
	  1.924082861566911e+00 -5.517156103566744e+00*I,
	  1.892306530941561e+00 -5.542387431553168e+00*I,
	  1.860218668052037e+00 -5.566878625554922e+00*I,
	  1.827823416322576e+00 -5.590618205799061e+00*I,
	  1.795125189489399e+00 -5.613595040041363e+00*I,
	  1.762128667873340e+00 -5.635798360635033e+00*I,
	  1.728838794153246e+00 -5.657217781172780e+00*I,
	  1.695260768640283e+00 -5.677843312655792e+00*I,
	  1.661400044062376e+00 -5.697665379150133e+00*I,
	  1.627262319862125e+00 -5.716674832887869e+00*I,
	  1.592853536016235e+00 -5.734862968764162e+00*I,
	  1.558179866386691e+00 -5.752221538200529e+00*I,
	  1.523247711613906e+00 -5.768742762327634e+00*I,
	  1.488063691565026e+00 -5.784419344454957e+00*I,
	  1.452634637351395e+00 -5.799244481790199e+00*I,
	  1.416967582931051e+00 -5.813211876381226e+00*I,
	  1.381069756311445e+00 -5.826315745234171e+00*I,
	  1.344948570372413e+00 -5.838550829598154e+00*I,
	  1.308611613325992e+00 -5.849912403373337e+00*I,
	  1.272066638839258e+00 -5.860396280632131e+00*I,
	  1.235321555836085e+00 -5.869998822220303e+00*I,
	  1.198384418005701e+00 -5.878716941433742e+00*I,
	  1.161263413038260e+00 -5.886548108733398e+00*I,
	  1.123966851615087e+00 -5.893490355511100e+00*I,
	  1.086503156174458e+00 -5.899542276872216e+00*I,
	  1.048880849488922e+00 -5.904703033452109e+00*I,
	  1.011108543069563e+00 -5.908972352237201e+00*I,
	  9.731949254338241e-01 -5.912350526418285e+00*I,
	  9.351487502588733e-01 -5.914838414239774e+00*I,
	  8.969788244526493e-01 -5.916437436895316e+00*I,
	  8.586939961650639e-01 -5.917149575437155e+00*I,
	  8.203031427791904e-01 -5.916977366746719e+00*I,
	  7.818151588962988e-01 -5.915923898543835e+00*I,
	  7.432389443520300e-01 -5.913992803484123e+00*I,
	  7.045833922915505e-01 -5.911188252332491e+00*I,
	  6.658573773265859e-01 -5.907514946269734e+00*I,
	  6.270697438015735e-01 -5.902978108321751e+00*I,
	  5.882292942048265e-01 -5.897583473975793e+00*I,
	  5.493447777347854e-01 -5.891337280972416e+00*I,
	  5.104248790607253e-01 -5.884246258335842e+00*I,
	  4.714782072893466e-01 -5.876317614654221e+00*I,
	  4.325132851738565e-01 -5.867559025667048e+00*I,
	  3.935385385721261e-01 -5.857978621175568e+00*I,
	  3.545622861960162e-01 -5.847584971336447e+00*I,
	  3.155927296463285e-01 -5.836387072349149e+00*I,
	  2.766379437706770e-01 -5.824394331602753e+00*I,
	  2.377058673570045e-01 -5.811616552309505e+00*I,
	  1.988042941722966e-01 -5.798063917677225e+00*I,
	  1.599408643736860e-01 -5.783746974657917e+00*I,
	  1.211230562929979e-01 -5.768676617320152e+00*I,
	  8.235817861790733e-02 -5.752864069881837e+00*I,
	  4.365336296880574e-02 -5.736320869452752e+00*I,
	  5.015556887989617e-03 -5.719058848514481e+00*I,
	  -3.354848274911332e-02 -5.701090117225607e+00*I,
	  -7.203219590011113e-02 -5.682427045536405e+00*I,
	  -1.104292250897970e-01 -5.663082245201458e+00*I,
	  -1.487334207097630e-01 -5.643068551704352e+00*I,
	  -1.869388458825326e-01 -5.622399006152689e+00*I,
	  -2.250397808872696e-01 -5.601086837154723e+00*I,
	  -2.630307271473230e-01 -5.579145442774821e+00*I,
	  -3.009064107807990e-01 -5.556588372532166e+00*I,
	  -3.386617857143850e-01 -5.533429309539090e+00*I,
	  -3.762920363717054e-01 -5.509682052771050e+00*I,
	  -4.137925799315828e-01 -5.485360499536321e+00*I,
	  -4.511590681671241e-01 -5.460478628139937e+00*I,
	  -4.883873888729147e-01 -5.435050480824952e+00*I,
	  -5.254736668838290e-01 -5.409090146957280e+00*I,
	  -5.624142646930813e-01 -5.382611746534445e+00*I,
	  -5.992057826899587e-01 -5.355629414000359e+00*I,
	  -6.358450590112629e-01 -5.328157282430213e+00*I,
	  -6.723291690271191e-01 -5.300209468071402e+00*I,
	  -7.086554244716692e-01 -5.271800055295008e+00*I,
	  -7.448213722259076e-01 -5.242943081937853e+00*I,
	  -7.808247927641940e-01 -5.213652525086898e+00*I,
	  -8.166636982884790e-01 -5.183942287286835e+00*I,
	  -8.523363305462606e-01 -5.153826183221470e+00*I,
	  -8.878411583571502e-01 -5.123317926851976e+00*I,
	  -9.231768748582739e-01 -5.092431119035929e+00*I,
	  -9.583423944808228e-01 -5.061179235622302e+00*I,
	  -9.933368496691140e-01 -5.029575616043366e+00*I,
	  -1.028159587366078e+00 -4.997633452389815e+00*I,
	  -1.062810165264257e+00 -4.965365778998758e+00*I,
	  -1.097288347847501e+00 -4.932785462540767e+00*I,
	  -1.131594102230319e+00 -4.899905192603206e+00*I,
	  -1.165727593812740e+00 -4.866737472776792e+00*I,
	  -1.199689181758312e+00 -4.833294612240080e+00*I,
	  -1.233479414317426e+00 -4.799588717836622e+00*I,
	  -1.267099023997061e+00 -4.765631686651281e+00*I,
	  -1.300548922600298e+00 -4.731435199077942e+00*I,
	  -1.333830196137910e+00 -4.697010712357513e+00*I,
	  -1.366944099635059e+00 -4.662369454598593e+00*I,
	  -1.399892051829428e+00 -4.627522419259806e+00*I,
	  -1.432675629795647e+00 -4.592480360091337e+00*I,
	  -1.465296563477859e+00 -4.557253786530951e+00*I,
	  -1.497756730161777e+00 -4.521852959534226e+00*I,
	  -1.530058148890905e+00 -4.486287887845388e+00*I,
	  -1.562202974829628e+00 -4.450568324667805e+00*I,
	  -1.594193493594014e+00 -4.414703764761586e+00*I,
	  -1.626032115549142e+00 -4.378703441919896e+00*I,
	  -1.657721370087062e+00 -4.342576326849078e+00*I,
	  -1.689263899888338e+00 -4.306331125403536e+00*I,
	  -1.720662455180513e+00 -4.269976277197798e+00*I,
	  -1.751919887992081e+00 -4.233519954545403e+00*I,
	  -1.783039146418711e+00 -4.196970061753066e+00*I,
	  -1.814023268899837e+00 -4.160334234721198e+00*I,
	  -1.844875378514281e+00 -4.123619840871423e+00*I,
	  -1.875598677299065e+00 -4.086833979354684e+00*I,
	  -1.906196440595426e+00 -4.049983481559356e+00*I,
	  -1.936672011430353e+00 -4.013074911874153e+00*I,
	  -1.967028794932553e+00 -3.976114568729336e+00*I,
	  -1.997270252789836e+00 -3.939108485872981e+00*I,
	  -2.027399897749376e+00 -3.902062433895451e+00*I,
	  -2.057421288164167e+00 -3.864981921966105e+00*I,
	  -2.087338022587055e+00 -3.827872199791231e+00*I,
	  -2.117153734416810e+00 -3.790738259765262e+00*I,
	  -2.146872086596252e+00 -3.753584839323220e+00*I,
	  -2.176496766365232e+00 -3.716416423465506e+00*I,
	  -2.206031480067381e+00 -3.679237247459612e+00*I,
	  -2.235479948014248e+00 -3.642051299694678e+00*I,
	  -2.264845899404348e+00 -3.604862324686752e+00*I,
	  -2.294133067301098e+00 -3.567673826226624e+00*I,
	  -2.323345183666910e+00 -3.530489070658937e+00*I,
	  -2.352485974457346e+00 -3.493311090288632e+00*I,
	  -2.381559154767635e+00 -3.456142686894578e+00*I,
	  -2.410568424039476e+00 -3.418986435354666e+00*I,
	  -2.439517461321643e+00 -3.381844687367397e+00*I,
	  -2.468409920586867e+00 -3.344719575267226e+00*I
    };
    const REAL T[2] = {0, 0.539538444824356};

    const COMPLEX mainspec_exact[4] = {-1+1*I,-1-1*I,2+5*I,2-5*I};
    const COMPLEX auxspec_exact[1] = {
        -1.583310602588775 + 0.726145196371511*I
    };
    const UINT K_exact = sizeof(mainspec_exact) / sizeof(mainspec_exact[0]);
    const UINT M_exact = sizeof(auxspec_exact) / sizeof(auxspec_exact[0]);

    COMPLEX *mainspec = NULL;
    COMPLEX *auxspec = NULL;

    const UINT D = sizeof(q) / sizeof(q[0]);
    UINT K = D;
    UINT M = D;
    mainspec = malloc(K * sizeof(COMPLEX));
    auxspec = malloc(M * sizeof(COMPLEX));
    if (mainspec == NULL || auxspec == NULL) {
        ret_code = E_NOMEM;
        goto leave_fun;
    }

    // Compute main and auxiliary spectrum
    fnft_nsep_opts_t opts = fnft_nsep_default_opts();
    opts.filtering = fnft_nsep_filt_MANUAL;
    opts.bounding_box[0] = -2;
    opts.bounding_box[1] = 3;
    opts.bounding_box[2] = -10;
    opts.bounding_box[3] = 10;
    ret_code = fnft_nsep(D, q, T, &K, mainspec, &M, auxspec, NULL, +1, &opts);
    CHECK_RETCODE(ret_code, leave_fun);

    // Check that the main and auxiliary spectrum are correct
    REAL dist = misc_hausdorff_dist(K_exact, mainspec_exact, K, mainspec);
    if (dist > 2.7e-5) {
        ret_code = E_TEST_FAILED;
        goto leave_fun;
    }
    dist = misc_hausdorff_dist(M_exact, auxspec_exact, M, auxspec);
    if (dist > 1.4e-2) {
        ret_code = E_TEST_FAILED;
        goto leave_fun;
    }


leave_fun:
    free(mainspec);
    free(auxspec);
    return SUCCESS;
}

int main()
{
    if (fnft_nsep_test_numerical_focusing_3() == SUCCESS)
        return EXIT_SUCCESS;
    else
        return EXIT_FAILURE;
}
