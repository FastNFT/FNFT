/*
* This file is part of FNFT.  
*                                                                  
* FNFT is free software; you can redistribute it and/or
* modify it under the terms of the version 2 of the GNU General
* Public License as published by the Free Software Foundation.
*
* FNFT is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*                                                                      
* You should have received a copy of the GNU General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*
* Contributors:
* Sander Wahls (TU Delft) 2017-2018.
* Shrinivas Chimmalgi (TU Delft) 2017.
*/

#define FNFT_ENABLE_SHORT_NAMES

#include <stdio.h>
#include "fnft__nse_fscatter.h"
#include "fnft__misc.h"
#include "fnft__errwarn.h"

static INT nse_fscatter_test_focusing_2split4A()
{
    UINT i, D = 8, deg;
    INT W;
    REAL scl;
    INT ret_code;
    const REAL eps_t = 0.13;
    COMPLEX q[8];
    COMPLEX result[5*4*8];
    COMPLEX result_exact[132] = {
          0.994907518017052 -  5.43543055680538e-20*I,
                          0 +                     0*I,
         -0.020712199043404 +  0.000923741197891317*I,
         0.0105492568728742 -  0.000923741197891317*I,
        -0.0235739566899249 +   0.00207076059095325*I,
         0.0103983127160818 -  0.000917444277190809*I,
        -0.0162739823163611 +   0.00354298077833456*I,
        0.00579782008749822 -   0.00263182056479377*I,
        -0.0132561228535984 +   0.00590460541390968*I,
        0.00577041654403197 -   0.00262282277101786*I,
       -0.00904381999946927 +   0.00637567514277716*I,
        0.00308419450785924 -   0.00377106101255974*I,
       -0.00724649732010877 +    0.0084723177802417*I,
        0.00311802369323323 -   0.00377648946931727*I,
       -0.00597583538422882 +    0.0071140670873064*I,
        0.00269066877969312 -   0.00337233102925029*I,
       -0.00630419242555773 +   0.00756948425112729*I,
        0.00273667175715176 -   0.00339641781710418*I,
       -0.00554071250595867 +   0.00504104070971789*I,
        0.00270311819039054 -   0.00169640441335756*I,
       -0.00624559331281105 +   0.00376952449986715*I,
        0.00275760329888585 -   0.00171292306822107*I,
       -0.00449089260307192 +   0.00165836007851478*I,
        0.00169942765445797 +  6.68233019569039e-06*I,
       -0.00389042774972643 -  7.70161655971584e-05*I,
        0.00173768592606137 +  1.85944760720022e-05*I,
       -0.00201336264088109 -  0.000627639001082386*I,
       0.000273152473240297 +  0.000590887422299922*I,
      -0.000622945498955917 -   0.00135958631573913*I,
       0.000278924630567518 +  0.000609714461422113*I,
      -0.000278924630567518 -  0.000609714461422113*I,
                          0 +                     0*I,
                          0 +                     0*I,
                          0 +                     0*I,
         0.0186350951662219 +     0.012740661836125*I,
       -0.00931754758311095 -   0.00637033091806249*I,
          0.018240665661588 +    0.0125007781543764*I,
       0.000414025918189321 +  0.000225199777469656*I,
        -0.0153406110522706 +    0.0238156715110955*I,
        0.00784955215955245 -    0.0118450620712688*I,
        -0.0150677013349113 +    0.0234329176295146*I,
       0.000349214943798152 +  0.000676315169027774*I,
        -0.0344765054186729 +    0.0324318494190644*I,
         0.0173061312671957 -     0.016074057434483*I,
        -0.0340525623840233 +    0.0320300686799084*I,
      -0.000137811418898319 +   0.00117439768629221*I,
        -0.0220816619689482 +    0.0380447423115594*I,
         0.0110860068845885 -    0.0188327558854971*I,
        -0.0221923239584062 +    0.0377700866481837*I,
      -0.000199054642624767 +   0.00152602238119919*I,
         0.0100939962247782 +    0.0403908553582749*I,
       -0.00502698095142535 -    0.0200167478382072*I,
        0.00973296526189118 +     0.040342610338762*I,
       1.80995337631432e-05 +   0.00158818124122007*I,
         0.0330144774556946 +    0.0394207324756345*I,
        -0.0166326889122317 -    0.0196151076106564*I,
         0.0330272374576214 +    0.0396679794583938*I,
       -4.7110047925441e-05 +   0.00126045950873699*I,
         0.0261284137041993 +    0.0353733187625507*I,
        -0.0133218095147387 -    0.0177654755314642*I,
         0.0264188446909588 +    0.0358992767902835*I,
      -0.000170147652581714 +   0.00055834462030782*I,
       -0.00488439329335818 +    0.0285468992347758*I,
         0.0025091572885373 -    0.0145605066048288*I,
       -0.00501831457707459 +    0.0291210132096576*I,
                          0 +                     0*I,
                          0 +                     0*I,
        0.00501831457707459 +    0.0291210132096576*I,
        -0.0025091572885373 -    0.0145605066048288*I,
        0.00488439329335818 +    0.0285468992347758*I,
       0.000170147652581714 +   0.00055834462030782*I,
        -0.0264188446909588 +    0.0358992767902835*I,
         0.0133218095147387 -    0.0177654755314642*I,
        -0.0261284137041993 +    0.0353733187625507*I,
        4.7110047925441e-05 +   0.00126045950873699*I,
        -0.0330272374576214 +    0.0396679794583938*I,
         0.0166326889122317 -    0.0196151076106564*I,
        -0.0330144774556946 +    0.0394207324756345*I,
      -1.80995337631432e-05 +   0.00158818124122007*I,
       -0.00973296526189118 +     0.040342610338762*I,
        0.00502698095142535 -    0.0200167478382072*I,
        -0.0100939962247782 +    0.0403908553582749*I,
       0.000199054642624767 +   0.00152602238119919*I,
         0.0221923239584062 +    0.0377700866481837*I,
        -0.0110860068845885 -    0.0188327558854971*I,
         0.0220816619689482 +    0.0380447423115594*I,
       0.000137811418898319 +   0.00117439768629221*I,
         0.0340525623840233 +    0.0320300686799084*I,
        -0.0173061312671957 -     0.016074057434483*I,
         0.0344765054186729 +    0.0324318494190644*I,
      -0.000349214943798152 +  0.000676315169027774*I,
         0.0150677013349113 +    0.0234329176295146*I,
       -0.00784955215955245 -    0.0118450620712688*I,
         0.0153406110522706 +    0.0238156715110955*I,
      -0.000414025918189321 +  0.000225199777469656*I,
         -0.018240665661588 +    0.0125007781543764*I,
        0.00931754758311095 -   0.00637033091806249*I,
        -0.0186350951662219 +     0.012740661836125*I,
                          0 +                     0*I,
                          0 +                     0*I,
                          0 +                     0*I,
      -0.000278924630567518 +  0.000609714461422113*I,
       0.000278924630567518 -  0.000609714461422113*I,
      -0.000622945498955917 +   0.00135958631573913*I,
       0.000273152473240297 -  0.000590887422299922*I,
       -0.00201336264088109 +  0.000627639001082386*I,
        0.00173768592606137 -  1.85944760720024e-05*I,
       -0.00389042774972643 +  7.70161655971584e-05*I,
        0.00169942765445797 -  6.68233019569044e-06*I,
       -0.00449089260307192 -   0.00165836007851478*I,
        0.00275760329888585 +   0.00171292306822107*I,
       -0.00624559331281105 -   0.00376952449986715*I,
        0.00270311819039054 +   0.00169640441335756*I,
       -0.00554071250595867 -   0.00504104070971789*I,
        0.00273667175715176 +   0.00339641781710418*I,
       -0.00630419242555773 -   0.00756948425112729*I,
        0.00269066877969312 +   0.00337233102925029*I,
       -0.00597583538422882 -    0.0071140670873064*I,
        0.00311802369323323 +   0.00377648946931727*I,
       -0.00724649732010877 -    0.0084723177802417*I,
        0.00308419450785924 +   0.00377106101255974*I,
       -0.00904381999946927 -   0.00637567514277716*I,
        0.00577041654403197 +   0.00262282277101786*I,
        -0.0132561228535984 -   0.00590460541390968*I,
        0.00579782008749822 +   0.00263182056479377*I,
        -0.0162739823163611 -   0.00354298077833456*I,
         0.0103983127160818 +   0.00091744427719081*I,
        -0.0235739566899249 -   0.00207076059095325*I,
         0.0105492568728742 +  0.000923741197891317*I,
         -0.020712199043404 -  0.000923741197891317*I,
                          0 +                     0*I,
          0.994907518017052 -  5.43543055680538e-20*I,};

    /* Matlab code to generate result_exact:
    e = 0.13;
    kappa = 1; D=8; q = 0.4*cos(1:D)+0.5j*sin(0.3*(1:D));
    r=-kappa*conj(q);
    ms=5;% 4th degree polynomial scheme
    S=zeros(2,2*ms,D);
    for n=1:D
        if q(n) == 0
            B11 = 1; B12 = 0; B13 = 0; B14 = 1;
        else
            B11=cosh(0.5*e*q(n)^(1/2)*r(n)^(1/2));
            B12= (sinh(0.5*e*(q(n)*r(n))^(1/2))*(q(n)*r(n))^(1/2))/r(n);
            B13 = -kappa * conj(B12);
            B14=(B11);
        end
        % Scattering matrix at n
        S(:,:,n)=[[B11^2-(B12*B13)/3,0,(4*B12*B13)/3,0,0],[0,(4*B11*B12)/3 ,-(B12*B14)/3-(B11*B12)/3,(4*B12*B14)/3,0];...
                 [0,(4*B11*B13)/3,-(B13*B14)/3-(B11*B13)/3,(4*B13*B14)/3,0],[0,0,(4*B12*B13)/3,0, B14^2-(B12*B13)/3]];
    end
    % Multiply scattering matrices
    temp=S(:,:,D);
    m=ms;
    for n=D-1:-1:1
        temp=[conv(temp(1,1:m),S(1,1:ms,n))+conv(temp(1,m+1:end),S(2,1:ms,n)),...
            conv(temp(1,1:m),S(1,ms+1:end,n))+conv(temp(1,m+1:end),S(2,ms+1:end,n));...
            conv(temp(2,1:m),S(1,1:ms,n))+conv(temp(2,m+1:end),S(2,1:ms,n)),...
            conv(temp(2,1:m),S(1,ms+1:end,n))+conv(temp(2,m+1:end),S(2,ms+1:end,n))];
         m=length(temp)/2;
    end
    format long g; result_exact = [temp(1,1:m) temp(1,m+1:end) temp(2,1:m) temp(2,m+1:end)].'
    */

    for (i=0; i<D; i++)
        q[i] = 0.4*COS(i+1) + 0.5*I*SIN(0.3*(i+1));

    // without normalization
    ret_code = nse_fscatter(D, q, eps_t, +1, result, &deg, NULL, nse_discretization_2SPLIT4A);
    if (ret_code != SUCCESS)
        return E_SUBROUTINE(ret_code);
    if (misc_rel_err(4*(deg+1), result, result_exact) > 100*EPSILON)
        return E_TEST_FAILED;

    // with normalization
    ret_code = nse_fscatter(D, q, eps_t, +1, result, &deg, &W,nse_discretization_2SPLIT4A);
    if (ret_code != SUCCESS)
        return E_SUBROUTINE(ret_code);
    if (W == 0)
        return E_TEST_FAILED;
    scl = POW(2.0, W);
    for (i=0; i<4*(deg+1); i++)
        result[i] *= scl;
    if (misc_rel_err(4*(deg+1), result, result_exact) > 100*EPSILON)
        return E_TEST_FAILED;

    return SUCCESS;
}

INT main()
{
    if (nse_fscatter_test_focusing_2split4A() != SUCCESS)
        return EXIT_FAILURE;

    return EXIT_SUCCESS;
}
