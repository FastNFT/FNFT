% For D = 512
M = 16;

contspec_num = [8.857878018066e-002+1.235928273764e-001j, 1.412952988180e-001+5.618741686497e-002j, 1.458301777789e-001+-4.306909021516e-002j, 7.339667135989e-002+-1.331702516198e-001j, -6.236758747611e-002+-1.386783015314e-001j, -1.520337376168e-001+-2.670189038379e-003j, -2.473800832870e-002+1.500313908059e-001j, 1.520571842539e-001+-1.924579873106e-016j, -2.473800832869e-002+-1.500313908059e-001j, -1.520337376168e-001+2.670189038391e-003j, -6.236758747611e-002+1.386783015314e-001j, 7.339667135990e-002+1.331702516197e-001j, 1.458301777789e-001+4.306909021515e-002j, 1.412952988176e-001+-5.618741686527e-002j, 8.857878018080e-002+-1.235928273761e-001j, 2.038116848616e-002+-1.506850862719e-001j, 5.757620711743e-001+8.033533779466e-001j, 9.184194423173e-001+3.652182096223e-001j, 9.478961555627e-001+-2.799490863986e-001j, 4.770783638393e-001+-8.656066355289e-001j, -4.053893185947e-001+-9.014089599542e-001j, -9.882192945092e-001+-1.735622874946e-002j, -1.607970541365e-001+9.752040402386e-001j, 9.883716976505e-001+7.330542922333e-016j, -1.607970541365e-001+-9.752040402386e-001j, -9.882192945092e-001+1.735622874954e-002j, -4.053893185947e-001+9.014089599541e-001j, 4.770783638394e-001+8.656066355281e-001j, 9.478961555626e-001+2.799490863985e-001j, 9.184194423147e-001+-3.652182096243e-001j, 5.757620711752e-001+-8.033533779449e-001j, 1.324775951600e-001+-9.794530607676e-001j];
contspec_exact = [8.787570611436e-004+2.408088150114e-004j, 1.875609592411e-003+-6.897800621394e-004j, 2.167561273750e-003+-3.809743560787e-003j, -2.707950757808e-003+-9.225347158596e-003j, -1.981270952499e-002+-7.248964492162e-003j, -3.377817869481e-002+3.172732676694e-002j, 4.362974545088e-002+9.078327397334e-002j, 1.631306710314e-001+0.000000000000e+000j, 4.362974545088e-002+-9.078327397334e-002j, -3.377817869481e-002+-3.172732676694e-002j, -1.981270952499e-002+7.248964492162e-003j, -2.707950757808e-003+9.225347158596e-003j, 2.167561273750e-003+3.809743560787e-003j, 1.875609592411e-003+6.897800621394e-004j, 8.787570611436e-004+-2.408088150114e-004j, 2.832750817195e-004+-3.038702430588e-004j, 5.711920897433e-003+1.565257297574e-003j, 1.219146235067e-002+-4.483570403906e-003j, 1.408914827938e-002+-2.476333314512e-002j, -1.760167992575e-002+-5.996475653088e-002j, -1.287826119124e-001+-4.711826919906e-002j, -2.195581615162e-001+2.062276239851e-001j, 2.835933454307e-001+5.900912808267e-001j, 1.060349361704e+000+0.000000000000e+000j, 2.835933454307e-001+-5.900912808267e-001j, -2.195581615162e-001+-2.062276239851e-001j, -1.287826119124e-001+4.711826919906e-002j, -1.760167992575e-002+5.996475653088e-002j, 1.408914827938e-002+2.476333314512e-002j, 1.219146235067e-002+4.483570403906e-003j, 5.711920897433e-003+-1.565257297574e-003j, 1.841288031177e-003+-1.975156579882e-003j];

ab_num = [6.029788402621e-001+-7.977346780803e-001j, -7.726680033952e-001+-6.346743013710e-001j, -7.235026763236e-001+6.897199850065e-001j, 5.115505354958e-001+8.569329135311e-001j, 9.739517090370e-001+-1.803653027752e-001j, 3.210358149850e-001+-9.010811282914e-001j, -4.309988026661e-001+-7.136347413931e-001j, -6.818433384501e-001+-1.855527090002e-012j, -4.309988026686e-001+7.136347413949e-001j, 3.210358149872e-001+9.010811282915e-001j, 9.739517090371e-001+1.803653027718e-001j, 5.115505354930e-001+-8.569329135278e-001j, -7.235026763228e-001+-6.897199850060e-001j, -7.726680033964e-001+6.346743013681e-001j, 6.029788402606e-001+7.977346780810e-001j, 7.815098573530e-001+-6.238869126888e-001j, -8.518254254539e-004+3.232458569513e-004j, 1.664015050487e-003+1.106269995094e-003j, -1.518390529780e-004+-4.378672702738e-003j, -7.603409875312e-003+5.853054517191e-003j, 2.000412575651e-002+6.042791004780e-003j, -1.428162420139e-002+-4.196539410408e-002j, -4.888510703707e-002+6.827496953840e-002j, 1.112295612776e-001+-7.390039197869e-014j, -4.888510703711e-002+-6.827496953836e-002j, -1.428162420132e-002+4.196539410412e-002j, 2.000412575647e-002+-6.042791004809e-003j, -7.603409875372e-003+-5.853054517181e-003j, -1.518390530216e-004+4.378672702653e-003j, 1.664015050457e-003+-1.106269995072e-003j, -8.518254254219e-004+-3.232458568760e-004j, 1.062682235214e-004+4.015754852980e-004j, -5.536865265454e-003+2.101098070184e-003j, 1.081609782817e-002+7.190754968111e-003j, -9.869538443557e-004+-2.846137256780e-002j, -4.942216418952e-002+3.804485436174e-002j, 1.300268174173e-001+3.927814153107e-002j, -9.283055730904e-002+-2.727750616765e-001j, -3.177531957410e-001+4.437873019996e-001j, 7.229921483044e-001+-4.811321711410e-013j, -3.177531957412e-001+-4.437873019994e-001j, -9.283055730861e-002+2.727750616768e-001j, 1.300268174171e-001+-3.927814153126e-002j, -4.942216418992e-002+-3.804485436168e-002j, -9.869538446417e-004+2.846137256725e-002j, 1.081609782797e-002+-7.190754967965e-003j, -5.536865265243e-003+-2.101098069698e-003j, 6.907434528828e-004+2.610240654438e-003j];
ab_exact = [-9.644260197536e-001+2.642849739162e-001j, -9.384622196167e-001+-3.451318071639e-001j, -4.943100550496e-001+-8.688079880664e-001j, 2.810892903972e-001+-9.576046680321e-001j, 9.302059085550e-001+-3.403385888745e-001j, 6.972263717197e-001+6.548940701021e-001j, -3.611240215511e-001+7.514144455356e-001j, -6.818433382465e-001+0.000000000000e+000j, -3.611240215511e-001+-7.514144455356e-001j, 6.972263717197e-001+-6.548940701021e-001j, 9.302059085550e-001+3.403385888745e-001j, 2.810892903972e-001+9.576046680321e-001j, -4.943100550496e-001+8.688079880664e-001j, -9.384622196167e-001+3.451318071639e-001j, -9.644260197536e-001+-2.642849739162e-001j, -6.818818551989e-001+-7.314572246134e-001j, 9.111383262032e-004+0.000000000000e+000j, 1.998253780620e-003+0.000000000000e+000j, 4.381382970647e-003+0.000000000000e+000j, 9.595411460231e-003+0.000000000000e+000j, 2.089700181070e-002+0.000000000000e+000j, 4.432907513454e-002+0.000000000000e+000j, 8.397161261306e-002+0.000000000000e+000j, 1.112295613064e-001+0.000000000000e+000j, 8.397161261306e-002+0.000000000000e+000j, 4.432907513454e-002+0.000000000000e+000j, 2.089700181070e-002+0.000000000000e+000j, 9.595411460231e-003+0.000000000000e+000j, 4.381382970647e-003+0.000000000000e+000j, 1.998253780620e-003+0.000000000000e+000j, 9.111383262032e-004+0.000000000000e+000j, 4.154282228850e-004+0.000000000000e+000j, 5.922399120321e-003+0.000000000000e+000j, 1.298864957403e-002+0.000000000000e+000j, 2.847898930921e-002+0.000000000000e+000j, 6.237017449150e-002+0.000000000000e+000j, 1.358305117695e-001+0.000000000000e+000j, 2.881389883745e-001+0.000000000000e+000j, 5.458154819849e-001+0.000000000000e+000j, 7.229921484916e-001+0.000000000000e+000j, 5.458154819849e-001+0.000000000000e+000j, 2.881389883745e-001+0.000000000000e+000j, 1.358305117695e-001+0.000000000000e+000j, 6.237017449150e-002+0.000000000000e+000j, 2.847898930921e-002+0.000000000000e+000j, 1.298864957403e-002+0.000000000000e+000j, 5.922399120321e-003+0.000000000000e+000j, 2.700283448752e-003+0.000000000000e+000j];

a_num = ab_num(1:M);
a_ex = ab_exact(1:M);
b1_num = ab_num(M+1:2*M);
b1_ex = ab_exact(M+1:2*M);

ab_abs_values = [abs(ab_num)', abs(ab_exact)'];
contspec_abs_values = [abs(contspec_num)', abs(contspec_exact)'];
ab_err = (abs(ab_num)-abs(ab_exact))';
contspec_err = (abs(contspec_num)-abs(contspec_exact))';

rel_err_a = zeros(M,1); rel_err_b1 = zeros(M,1); rel_err_b2 = zeros(M,1);
for i = 1:M
    rel_err_a(i) = (abs(ab_num(i))-abs(ab_exact(i)))/abs(ab_exact(i));
    rel_err_b1(i) = (abs(ab_num(i+M))-abs(ab_exact(i+M)))/abs(ab_exact(i+M));
    rel_err_b2(i) = (abs(ab_num(i+2*M))-abs(ab_exact(i+2*M)))/abs(ab_exact(i+2*M));
end

rel_err_contspec = zeros(2*M,1);
for i = 1:2*M
    rel_err_contspec(i) = (abs(contspec_num(i))-abs(contspec_exact(i)))/abs(contspec_exact(i));
end

%% code to try out phase factors
eps_t = 50/511;
t_step_sizes = eps_t;
T = [-25-0.5*eps_t 25+0.5*eps_t];

D = 512;
b1_num = ab_num(M+1:2*M);
b1_exact = ab_exact(M+1:2*M);

phase_factor = +eps_t/3;
phase_factor = -eps_t*D - (T(2)+eps_t*0.5) - (T(1)-eps_t*0.5)% + eps_t/3
%phase_factor = -eps_t*(D-1) + (T1+eps_t*0.5) - (T0-eps_t*0.5)     % also works pretty well for real part, slightly worse for imag part
phase_factor = 0
xi = (-sym(7):sym(8))/4;        % xi has 16 elements, M = 16

b1_C = zeros(M,1);
for i = 1:M
    b1_C(i) = b1_num(i)*exp(1i*xi(i)*phase_factor);
end
b1_side_by_side = [b1_exact', b1_C];
real_err = abs(sum(real(b1_C))+sum(real(b1_exact)))
imag_err = abs(sum(imag(b1_C))-sum(imag(b1_exact)))